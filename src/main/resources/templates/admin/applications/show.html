<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin-layout}">
<head>
    <title>Chi tiết hồ sơ ứng tuyển</title>
</head>
<body>
<div layout:fragment="content">
    <section class="admin-application-detail">
        <div class="pagetitle detail-heading">
            <div>
                <p class="detail-subtitle text-uppercase text-muted mb-1">Quản lý hồ sơ ứng tuyển</p>
                <h1>Chi tiết hồ sơ #<span th:text="${application.id}">1</span></h1>
            </div>
            <a class="btn btn-outline-secondary btn-back" th:href="@{/admin/applications}">
                <i class="bi bi-arrow-left me-2"></i>Quay lại danh sách
            </a>
        </div>

        <nav aria-label="breadcrumb" class="detail-breadcrumb mb-4">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a th:href="@{/admin}">Trang chủ</a></li>
                <li class="breadcrumb-item"><a th:href="@{/admin/applications}">Hồ sơ ứng tuyển</a></li>
                <li class="breadcrumb-item active" th:text="${application.id}">1</li>
            </ol>
        </nav>

        <div th:if="${flashMessage}"
             th:class="${'alert alert-' + flashType + ' alert-dismissible fade show detail-alert'}"
             role="alert">
            <i th:class="${flashType == 'success' ? 'bi bi-check-circle me-1' : 'bi bi-exclamation-triangle me-1'}"></i>
            <span th:text="${flashMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div class="row g-4 detail-grid">
            <div class="col-xl-8">
                <div class="card detail-card h-100">
                    <div class="card-body">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-start gap-3 mb-4">
                        <div>
                            <span class="status-pill" th:classappend="${' status-pill-' + application.status}"
                                  th:text="${application.statusLabel}">Đã ứng tuyển</span>
                            <h2 class="h4 mt-3 mb-1" th:text="${application.candidateName ?: 'Ứng viên'}">Ứng viên</h2>
                            <div class="text-muted">
                                <i class="bi bi-envelope me-2"></i><span th:text="${application.candidateEmail}">email@example.com</span>
                                <span class="ms-3" th:if="${application.candidatePhone}">
                                    <i class="bi bi-telephone me-2"></i><span th:text="${application.candidatePhone}">0123</span>
                                </span>
                            </div>
                            <div class="text-muted small mt-1" th:if="${application.candidateLocation}">
                                <i class="bi bi-geo-alt me-1"></i><span th:text="${application.candidateLocation}">Hà Nội</span>
                            </div>
                        </div>
                        <div class="text-muted text-md-end">
                            <div class="fw-semibold">Ứng tuyển lúc</div>
                            <div th:if="${application.appliedAt != null}"
                                 th:text="${#temporals.format(application.appliedAt, 'dd/MM/yyyy HH:mm')}">01/01/2024</div>
                            <div th:if="${application.appliedAt == null}">—</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="fw-semibold">Tiến độ xử lý</div>
                            <div class="text-muted small" th:text="${application.statusProgress + '% hoàn tất'}">0% hoàn tất</div>
                        </div>
                        <div class="progress status-progress">
                            <div class="progress-bar" th:classappend="${' bg-' + application.statusBadge}"
                                 role="progressbar"
                                 th:style="${'width: ' + application.statusProgress + '%'}"
                                 th:aria-valuenow="${application.statusProgress}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <ul class="status-steps mt-3 mb-0">
                            <li th:each="step : ${application.statusSteps}"
                                class="status-step"
                                th:classappend="${step.completed ? ' is-completed' : ''}">
                                <span class="status-step-index"
                                      th:classappend="${step.completed ? ' status-step-index-active bg-' + step.badge : ''}"
                                      th:text="${step.order}">1</span>
                                <div class="status-step-body">
                                    <div class="fw-semibold mb-1 d-flex align-items-center gap-2">
                                        <span th:text="${step.label}">Trạng thái</span>
                                        <span class="badge bg-light text-dark border" th:if="${step.current}">Hiện tại</span>
                                    </div>
                                    <div class="text-muted small" th:text="${step.description}">Mô tả</div>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <div class="detail-section">
                        <h5 class="card-title">Tổng quan ứng viên</h5>
                        <div th:if="${application.candidateSummary}" class="mb-3" style="white-space: pre-wrap;"
                             th:text="${application.candidateSummary}"></div>
                        <p class="text-muted" th:if="${application.candidateSummary == null}">Ứng viên chưa cập nhật tóm tắt kinh nghiệm.</p>
                        <div class="alert alert-secondary mb-0" th:if="${application.candidateHeadline}" role="alert">
                            <strong>Tiêu đề hồ sơ:</strong> <span th:text="${application.candidateHeadline}">Headline</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h5 class="card-title">Thư giới thiệu</h5>
                        <div class="bg-light rounded-3 p-3" th:if="${application.coverLetter}"
                             th:text="${application.coverLetter}" style="white-space: pre-wrap;"></div>
                        <p class="text-muted" th:if="${application.coverLetter == null}">Ứng viên chưa đính kèm thư giới thiệu.</p>
                    </div>

                    <div class="detail-section">
                        <h5 class="card-title">Ghi chú từ nhà tuyển dụng</h5>
                        <div class="bg-light rounded-3 p-3" th:if="${application.decisionNote}"
                             style="white-space: pre-wrap;" th:text="${application.decisionNote}"></div>
                        <p class="text-muted mb-0" th:if="${application.decisionNote == null}">Chưa có phản hồi nào được gửi cho ứng viên.</p>
                    </div>

                    <div class="detail-section">
                        <h5 class="card-title">Tóm tắt hồ sơ đính kèm</h5>
                        <pre class="bg-dark text-white rounded-3 p-3 small mb-0" style="white-space: pre-wrap;"
                             th:if="${application.resumeSnapshot}"
                             th:text="${application.resumeSnapshot}"></pre>
                        <p class="text-muted" th:if="${application.resumeSnapshot == null}">Không có bản tóm tắt CV khi ứng tuyển.</p>
                    </div>
                    </div>
                </div>
            </div>

            <div class="col-xl-4 detail-sidebar">
                <div class="card detail-card sticky-card">
                    <div class="card-body">
                    <h5 class="card-title">Thông tin tin tuyển dụng</h5>
                    <dl class="row mb-0 small">
                        <dt class="col-5 text-secondary">Tiêu đề</dt>
                        <dd class="col-7 fw-semibold">
                            <th:block th:if="${application.jobId != null}">
                                <a th:href="@{/admin/jobs/{id}/edit(id=${application.jobId})}"
                                   class="text-decoration-none"
                                   th:text="${application.jobTitle}">Tin tuyển dụng</a>
                            </th:block>
                            <span th:if="${application.jobId == null}" th:text="${application.jobTitle}">Tin tuyển dụng</span>
                        </dd>
                        <dt class="col-5 text-secondary">Nhà tuyển dụng</dt>
                        <dd class="col-7" th:text="${application.employerName ?: 'Không xác định'}">Doanh nghiệp</dd>
                        <dt class="col-5 text-secondary" th:if="${application.jobLocation}">Địa điểm</dt>
                        <dd class="col-7" th:if="${application.jobLocation}" th:text="${application.jobLocation}">Hà Nội</dd>
                        <dt class="col-5 text-secondary" th:if="${application.jobEmploymentType}">Hình thức</dt>
                        <dd class="col-7" th:if="${application.jobEmploymentType}" th:text="${application.jobEmploymentType}">Full-time</dd>
                        <dt class="col-5 text-secondary" th:if="${application.jobSalary}">Mức lương</dt>
                        <dd class="col-7" th:if="${application.jobSalary}" th:text="${application.jobSalary}">10-15 triệu</dd>
                    </dl>
                    <div class="bg-light rounded-3 p-3 mt-3 small text-secondary" style="max-height: 220px; overflow-y: auto;"
                         th:if="${application.jobDescription}"
                         th:utext="${#strings.replace(#strings.escapeXml(application.jobDescription), '\n', '<br/>')}"></div>
                    </div>
                </div>

                <div class="card detail-card">
                    <div class="card-body">
                    <h5 class="card-title">Kỹ năng nổi bật</h5>
                    <div class="d-flex flex-wrap gap-2"
                         th:if="${application.skillTags != null and !#lists.isEmpty(application.skillTags)}">
                        <span class="badge bg-light text-dark border" th:each="tag : ${application.skillTags}"
                              th:text="${'#' + tag}">#Java</span>
                    </div>
                    <p class="text-muted"
                       th:if="${application.skillTags == null or #lists.isEmpty(application.skillTags)}">
                        Chưa có kỹ năng nào được liệt kê.
                    </p>
                    </div>
                </div>

                <div class="card detail-card">
                    <div class="card-body">
                    <h5 class="card-title">Tài liệu &amp; liên hệ</h5>
                    <dl class="row small mb-0">
                        <dt class="col-5 text-secondary">Email tuyển dụng</dt>
                        <dd class="col-7" th:text="${application.employerEmail ?: 'Chưa cập nhật'}">hr@example.com</dd>
                        <dt class="col-5 text-secondary" th:if="${application.candidatePhone}">Điện thoại ứng viên</dt>
                        <dd class="col-7" th:if="${application.candidatePhone}" th:text="${application.candidatePhone}">0123456789</dd>
                    </dl>
                    <a class="btn btn-success w-100 mt-3"
                       th:if="${application.candidateCvUrl != null}"
                       th:href="${application.candidateCvUrl}"
                       target="_blank" rel="noopener">
                        <i class="bi bi-download me-2"></i>Tải CV ứng viên
                    </a>
                    <div class="alert alert-warning mt-3 mb-0" role="alert"
                         th:if="${application.candidateCvUrl == null}">
                        Ứng viên chưa tải CV lên hệ thống.
                    </div>
                    </div>
                </div>

                <div class="card detail-card">
                    <div class="card-body">
                    <h5 class="card-title">Cập nhật trạng thái</h5>
                    <form method="post" th:action="@{/admin/applications/{id}/update-status(id=${application.id})}">
                        <div class="mb-3">
                            <label for="status" class="form-label">Chọn trạng thái mới</label>
                            <select class="form-select" id="status" name="status" required>
                                <option th:each="statusKey : ${statusOptions}"
                                        th:value="${statusKey}"
                                        th:selected="${application.status == statusKey}"
                                        th:text="${statusLabels.get(statusKey)}"></option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-check-circle me-1"></i>Cập nhật
                        </button>
                    </form>
                    </div>
                </div>

                <div class="card detail-card">
                    <div class="card-body">
                    <h5 class="card-title">Thao tác nhanh</h5>
                    <div class="d-grid gap-2">
                        <a th:href="@{/admin/applications}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Quay lại danh sách
                        </a>
                        <th:block th:if="${application.jobId != null}">
                            <a th:href="@{/admin/jobs/{id}/edit(id=${application.jobId})}"
                               class="btn btn-outline-primary">
                                <i class="bi bi-briefcase me-1"></i>Xem tin tuyển dụng
                            </a>
                        </th:block>
                        <form method="post" th:action="@{/admin/applications/{id}/delete(id=${application.id})}"
                              onsubmit="return confirm('Bạn có chắc chắn muốn xóa hồ sơ này?');">
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="bi bi-trash me-1"></i>Xóa hồ sơ
                            </button>
                        </form>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
</body>
</html>
