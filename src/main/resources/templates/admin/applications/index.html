<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin-layout}">
<head>
    <title>Giám sát hồ sơ ứng tuyển</title>
</head>
<body>
<div layout:fragment="content">
    <div class="pagetitle">
        <h1>Giám sát hồ sơ ứng tuyển</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin}">Trang chủ</a></li>
                <li class="breadcrumb-item active">Hồ sơ ứng tuyển</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div th:if="${flashMessage}"
             th:class="${'alert alert-' + flashType + ' alert-dismissible fade show'}"
             role="alert">
            <i th:class="${flashType == 'success' ? 'bi bi-check-circle me-1' : 'bi bi-exclamation-triangle me-1'}"></i>
            <span th:text="${flashMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-xxl-2 col-md-4">
                <div class="card info-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Tổng hồ sơ</h5>
                        <div class="d-flex align-items-center">
                            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                <i class="bi bi-files"></i>
                            </div>
                            <div class="ps-3">
                                <h6 th:text="${totalApplications}">0</h6>
                                <span class="text-muted small">Tất cả thời gian</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xxl-2 col-md-4">
                <div class="card info-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">7 ngày gần nhất</h5>
                        <div class="d-flex align-items-center">
                            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                <i class="bi bi-calendar-week"></i>
                            </div>
                            <div class="ps-3">
                                <h6 th:text="${last7Days}">0</h6>
                                <span class="text-muted small">Hồ sơ mới</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xxl-2 col-md-4">
                <div class="card info-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">30 ngày</h5>
                        <div class="d-flex align-items-center">
                            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <div class="ps-3">
                                <h6 th:text="${last30Days}">0</h6>
                                <span class="text-muted small">Xu hướng gần đây</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xxl-2 col-md-4">
                <div class="card info-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Chờ duyệt</h5>
                        <div class="d-flex align-items-center">
                            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                <i class="bi bi-hourglass-split"></i>
                            </div>
                            <div class="ps-3">
                                <h6 th:text="${awaitingReview}">0</h6>
                                <span class="text-muted small">Applied + Viewed</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xxl-2 col-md-4">
                <div class="card info-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Đã chọn</h5>
                        <div class="d-flex align-items-center">
                            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                <i class="bi bi-star"></i>
                            </div>
                            <div class="ps-3">
                                <h6 th:text="${shortlistedCount}">0</h6>
                                <span class="text-muted small">Đã chọn phỏng vấn</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xxl-2 col-md-4">
                <div class="card info-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Đã tuyển dụng</h5>
                        <div class="d-flex align-items-center">
                            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                <i class="bi bi-patch-check"></i>
                            </div>
                            <div class="ps-3">
                                <h6 th:text="${hiredCount}">0</h6>
                                <span class="text-muted small">Hoàn tất</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Bộ lọc nâng cao</h5>
                        <form class="row gy-3" method="get" th:action="@{/admin/applications}">
                            <div class="col-md-6">
                                <label for="filterKeyword" class="form-label">Từ khóa</label>
                                <input type="text" id="filterKeyword" name="keyword" class="form-control"
                                       placeholder="Tên ứng viên, email, tin tuyển dụng..."
                                       th:value="${filterKeyword}">
                            </div>
                            <div class="col-md-3">
                                <label for="filterStatus" class="form-label">Trạng thái</label>
                                <select id="filterStatus" name="status" class="form-select">
                                    <option value="" th:selected="${#strings.isEmpty(filterStatus)}">Tất cả</option>
                                    <option th:each="statusKey : ${statusOptions}"
                                            th:value="${statusKey}"
                                            th:selected="${filterStatus == statusKey}"
                                            th:text="${statusLabels.get(statusKey)}">
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filterJob" class="form-label">ID tin tuyển dụng</label>
                                <input type="number" min="1" id="filterJob" name="jobId" class="form-control"
                                       th:value="${filterJobId}" placeholder="VD: 12">
                            </div>
                            <div class="col-md-3">
                                <label for="filterEmployer" class="form-label">ID nhà tuyển dụng</label>
                                <input type="number" min="1" id="filterEmployer" name="employerId" class="form-control"
                                       th:value="${filterEmployerId}" placeholder="VD: 5">
                            </div>
                            <div class="col-md-3">
                                <label for="filterDateFrom" class="form-label">Từ ngày</label>
                                <input type="date" id="filterDateFrom" name="dateFrom" class="form-control"
                                       th:value="${filterDateFrom}">
                            </div>
                            <div class="col-md-3">
                                <label for="filterDateTo" class="form-label">Đến ngày</label>
                                <input type="date" id="filterDateTo" name="dateTo" class="form-control"
                                       th:value="${filterDateTo}">
                            </div>
                            <div class="col-md-6 d-flex align-items-end justify-content-end gap-2">
                                <a th:href="@{/admin/applications}" class="btn btn-outline-secondary">Đặt lại</a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search me-1"></i>Lọc dữ liệu
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Phân bổ trạng thái</h5>
                        <div th:each="status : ${statusBreakdown}" class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span th:class="${'badge bg-' + status.badge}"
                                      th:text="${status.label}"></span>
                                <span class="fw-semibold" th:text="${status.count}">0</span>
                            </div>
                            <div class="progress mt-2" style="height: 6px;">
                                <div class="progress-bar"
                                     th:classappend="${' bg-' + status.badge}"
                                     role="progressbar"
                                     th:style="${'width: ' + status.percentage + '%'}"
                                     th:aria-valuenow="${status.percentage}" aria-valuemin="0"
                                     aria-valuemax="100"></div>
                            </div>
                            <div class="text-muted small mt-1"
                                 th:text="${status.percentage + '% tổng số hồ sơ'}"></div>
                            <div class="text-muted small" th:text="${status.description}">Mô tả</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2 mb-3">
                    <div class="text-muted small">
                        Đang hiển thị <strong th:text="${displayedCount}">0</strong> / <strong th:text="${totalRecords}">0</strong>
                        hồ sơ phù hợp.
                    </div>
                    <div class="badge bg-light text-primary border border-primary"
                         th:text="${'Trang ' + currentPage + ' / ' + (totalPages > 0 ? totalPages : 1)}">
                        Trang 1 / 1
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Ứng viên</th>
                            <th>Tin tuyển dụng</th>
                            <th>Trạng thái</th>
                            <th>Thời gian</th>
                            <th class="text-end">Theo dõi</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${#lists.isEmpty(applications)}">
                            <td colspan="6" class="text-center text-muted py-4">
                                Không có hồ sơ nào đáp ứng bộ lọc.
                            </td>
                        </tr>
                        <tr th:each="app : ${applications}">
                            <td class="fw-semibold" th:text="${'#' + app.id}">#1</td>
                            <td>
                                <div class="fw-semibold" th:text="${app.candidateName}">Ứng viên</div>
                                <div class="text-muted small" th:text="${app.candidateEmail}">email@example.com</div>
                                <div class="text-muted small" th:if="${app.candidateLocation}">
                                    <i class="bi bi-geo-alt me-1"></i>
                                    <span th:text="${app.candidateLocation}">Hà Nội</span>
                                </div>
                            </td>
                            <td>
                                <div class="fw-semibold">
                                    <th:block th:if="${app.jobId != null}">
                                        <a th:href="@{/admin/jobs/{id}/edit(id=${app.jobId})}"
                                           class="text-decoration-none"
                                           th:text="${app.jobTitle}">Tin tuyển dụng</a>
                                    </th:block>
                                    <span th:if="${app.jobId == null}" th:text="${app.jobTitle}">Tin tuyển dụng</span>
                                </div>
                                <div class="text-muted small" th:text="${app.employerName}">Doanh nghiệp</div>
                                <div class="text-muted small" th:if="${app.jobLocation}">
                                    <i class="bi bi-geo"></i>
                                    <span th:text="${app.jobLocation}">TP.HCM</span>
                                </div>
                            </td>
                            <td>
                                <span class="badge" th:classappend="${' bg-' + app.statusBadge}"
                                      th:text="${app.statusLabel}">Đã ứng tuyển</span>
                                <div class="progress mt-2" style="height: 6px;">
                                    <div class="progress-bar" th:classappend="${' bg-' + app.statusBadge}"
                                         role="progressbar"
                                         th:style="${'width: ' + app.statusProgress + '%'}"
                                         th:aria-valuenow="${app.statusProgress}" aria-valuemin="0"
                                         aria-valuemax="100"></div>
                                </div>
                                <div class="text-muted small mt-1">
                                    <span th:text="${app.statusProgress + '% hành trình'}">40% hành trình</span>
                                    ·
                                    <span th:text="${app.statusDescription}">Mô tả</span>
                                </div>
                            </td>
                            <td>
                                <div class="fw-semibold" th:if="${app.appliedAt != null}"
                                     th:text="${#temporals.format(app.appliedAt, 'dd/MM/yyyy HH:mm')}">01/01/2024</div>
                                <div class="fw-semibold" th:if="${app.appliedAt == null}">—</div>
                                <div class="text-muted small" th:if="${!#strings.isEmpty(app.notePreview)}">
                                    <i class="bi bi-chat-dots me-1"></i>
                                    <span th:text="${app.notePreview}">Ghi chú</span>
                                </div>
                            </td>
                            <td class="text-end">
                                <a class="btn btn-sm btn-outline-primary"
                                   th:href="@{/admin/applications/{id}(id=${app.id})}">
                                    <i class="bi bi-eye"></i> Chi tiết
                                </a>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <nav th:if="${totalPages > 1}" class="mt-4" aria-label="Phân trang hồ sơ">
                    <ul class="pagination justify-content-center">
                        <li class="page-item" th:classappend="${currentPage == 1 ? 'disabled' : ''}">
                            <a class="page-link"
                               th:href="@{/admin/applications(page=${currentPage - 1}, keyword=${filterKeyword}, status=${filterStatus}, jobId=${filterJobId}, employerId=${filterEmployerId}, dateFrom=${filterDateFrom}, dateTo=${filterDateTo})}" aria-label="Trang trước">&laquo;</a>
                        </li>
                        <li th:each="i : ${#numbers.sequence(1, totalPages)}"
                            class="page-item"
                            th:classappend="${i == currentPage ? 'active' : ''}">
                            <a class="page-link"
                               th:href="@{/admin/applications(page=${i}, keyword=${filterKeyword}, status=${filterStatus}, jobId=${filterJobId}, employerId=${filterEmployerId}, dateFrom=${filterDateFrom}, dateTo=${filterDateTo})}"
                               th:text="${i}">1</a>
                        </li>
                        <li class="page-item" th:classappend="${currentPage == totalPages ? 'disabled' : ''}">
                            <a class="page-link"
                               th:href="@{/admin/applications(page=${currentPage + 1}, keyword=${filterKeyword}, status=${filterStatus}, jobId=${filterJobId}, employerId=${filterEmployerId}, dateFrom=${filterDateFrom}, dateTo=${filterDateTo})}"
                               aria-label="Trang sau">&raquo;</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </section>
</div>
</body>
</html>
