<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin-layout}">
<head>
    <title>Sửa người dùng</title>
</head>
<body>
<div layout:fragment="content">
    <div class="pagetitle">
        <h1>Sửa người dùng</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}">Trang chủ</a></li>
                    <li class="breadcrumb-item"><a th:href="@{/admin/users}">Người dùng</a></li>
                    <li class="breadcrumb-item active">Sửa</li>
                </ol>
            </nav>
        </div>

        <section class="section">
            <!-- Flash Messages -->
            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div th:if="${warningMessage}" class="alert alert-warning alert-dismissible fade show" role="alert">
                <span th:text="${warningMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <form th:action="@{/admin/users/edit/{id}(id=${user.id})}" method="POST" enctype="multipart/form-data" class="row g-4">
                <!-- Left Column: Avatar Section -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body text-center d-flex flex-column justify-content-center">
                            <div id="avatarPreview" class="mx-auto d-flex align-items-center justify-content-center rounded-circle border bg-light" style="width: 140px; height: 140px; overflow: hidden;">
                                <img th:if="${user.avatarPath}" 
                                     th:src="@{${user.avatarPath}}" 
                                     class="w-100 h-100" 
                                     style="object-fit: cover;"
                                     alt="Current Avatar">
                                <i th:unless="${user.avatarPath}" class="bi bi-person fs-1 text-secondary"></i>
                            </div>
                            <p class="text-muted small mb-3 mt-3">Ảnh hiện tại của người dùng</p>
                            
                            <div class="mb-3 text-start">
                                <label for="avatar" class="form-label fw-semibold">Thay đổi ảnh đại diện (tùy chọn)</label>
                                <input type="file" 
                                       name="avatar" 
                                       id="avatar" 
                                       accept="image/png,image/jpeg,image/gif,image/webp" 
                                       class="form-control">
                                <div class="form-text">PNG, JPG, GIF, WEBP · tối đa 2MB.</div>
                            </div>
                            
                            <div class="border rounded p-3 text-start bg-light-subtle small">
                                <span class="fw-semibold mb-2 d-block">Lưu ý:</span>
                                <ul class="mb-0 ps-3">
                                    <li>Ảnh cũ sẽ bị xóa khi tải ảnh mới.</li>
                                    <li>Để trống nếu không muốn thay đổi.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: User Information -->
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title fw-bold mb-4">Thông tin tài khoản</h5>
                            
                            <div class="row g-3">
                                <!-- Name -->
                                <div class="col-md-6">
                                    <label for="name" class="form-label fw-semibold">Tên hiển thị <span class="text-danger">*</span></label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="name" 
                                           name="name" 
                                           th:value="${user.name}"
                                           required>
                                </div>

                                <!-- Email (Read-only) -->
                                <div class="col-md-6">
                                    <label for="email" class="form-label fw-semibold">Email (không thể thay đổi)</label>
                                    <input type="email" 
                                           class="form-control" 
                                           id="email" 
                                           th:value="${user.email}"
                                           readonly>
                                    <div class="form-text">Email không thể thay đổi sau khi tạo tài khoản.</div>
                                </div>

                                <!-- Role -->
                                <div class="col-md-6">
                                    <label for="roleId" class="form-label fw-semibold">Vai trò <span class="text-danger">*</span></label>
                                    <select class="form-select" id="roleId" name="roleId" required>
                                        <option th:each="role : ${roles}" 
                                                th:value="${role.id}" 
                                                th:text="${role.name}"
                                                th:selected="${role.id == user.role.id}">
                                            Role Name
                                        </option>
                                    </select>
                                    <div class="form-text">Thay đổi vai trò sẽ ảnh hưởng đến quyền truy cập của người dùng.</div>
                                </div>

                                <!-- User ID (Display only) -->
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">ID người dùng</label>
                                    <input type="text" 
                                           class="form-control" 
                                           th:value="${user.id}"
                                           readonly>
                                    <div class="form-text">ID duy nhất trong hệ thống.</div>
                                </div>

                                <!-- Password Info -->
                                <div class="col-12">
                                    <div class="alert alert-info d-flex align-items-start">
                                        <i class="bi bi-shield-lock me-2 flex-shrink-0"></i>
                                        <div class="small">
                                            <strong>Bảo mật:</strong> Để thay đổi mật khẩu, người dùng cần đăng nhập và 
                                            sử dụng chức năng "Đổi mật khẩu" trong trang cá nhân. Admin không thể xem hoặc 
                                            thay đổi mật khẩu trực tiếp.
                                        </div>
                                    </div>
                                </div>

                                <!-- Created Date -->
                                <div class="col-12" th:if="${user.createdAt}">
                                    <div class="border rounded p-3 bg-light">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small class="text-muted d-block">Ngày tạo tài khoản</small>
                                                <strong th:text="${#temporals.format(user.createdAt, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</strong>
                                            </div>
                                            <div class="col-md-6">
                                                <small class="text-muted d-block">Số điện thoại</small>
                                                <strong th:text="${user.phone ?: 'Chưa cập nhật'}">Chưa cập nhật</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-end gap-2 mt-3">
                        <a th:href="@{/admin/users}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Quay lại
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Lưu thay đổi
                        </button>
                    </div>
                </div>
            </form>
        </section>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
    // Avatar Preview on File Change
    document.getElementById('avatar').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('avatarPreview');
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = '<img src="' + e.target.result + '" class="w-100 h-100" style="object-fit: cover;">';
            }
            reader.readAsDataURL(file);
        }
    });
    </script>
</th:block>
</body>
</html>
