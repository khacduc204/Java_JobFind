<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{fragments/header :: head}" />
<body class="applications-page detail-page">
<th:block th:replace="~{fragments/header :: header}" />

<main class="application-detail">
    <section class="detail-hero">
        <div class="container detail-hero-grid">
            <div class="detail-hero-copy">
                <div class="detail-breadcrumb">
                    <a th:href="@{/dashboard}">Trang cá nhân</a>
                    <i class="fa-solid fa-chevron-right"></i>
                    <a th:href="@{/applications}">Đơn ứng tuyển</a>
                    <i class="fa-solid fa-chevron-right"></i>
                    <span>Chi tiết</span>
                </div>
                <h1 th:text="${application.job != null ? application.job.title : 'Chi tiết đơn ứng tuyển'}">Chi tiết đơn ứng tuyển</h1>
                <p class="detail-subtitle">
                    <span th:text="${application.job?.employerName != null ? application.job.employerName : 'Nhà tuyển dụng ẩn'}">Công ty A</span>
                    <span th:if="${application.job?.location != null && application.job.location != ''}">
                        <i class="fa-solid fa-circle fa-2xs mx-2"></i>
                        <span th:text="${application.job.location}">Hà Nội</span>
                    </span>
                </p>
                <div class="detail-meta">
                    <span class="status-chip" th:classappend="${' status-' + application.status}" th:text="${application.statusLabel}">Đã ứng tuyển</span>
                    <span class="meta-line">
                        <i class="fa-regular fa-calendar"></i>
                        Nộp ngày
                        <strong th:if="${application.appliedAt}" th:text="${#temporals.format(application.appliedAt, 'dd/MM/yyyy HH:mm')}"
                                >01/01/2024</strong>
                        <strong th:unless="${application.appliedAt}">Chưa cập nhật</strong>
                    </span>
                </div>
                <div class="detail-hero-actions">
                    <a th:if="${application.job?.id != null}" th:href="@{/jobs/{id}(id=${application.job.id})}" class="btn-solid">
                        <i class="fa-solid fa-briefcase me-2"></i>Xem tin tuyển dụng
                    </a>
                    <a th:href="@{/applications}" class="btn-ghost">
                        <i class="fa-solid fa-arrow-left me-2"></i>Quay lại danh sách
                    </a>
                </div>
            </div>
            <div class="detail-hero-panel">
                <div class="detail-panel-title">Ảnh chụp đơn ứng tuyển</div>
                <dl>
                    <div>
                        <dt>Trạng thái hiện tại</dt>
                        <dd th:text="${application.statusLabel}">Đã ứng tuyển</dd>
                    </div>
                    <div>
                        <dt>Công ty</dt>
                        <dd th:text="${application.job?.employerName != null ? application.job.employerName : 'Đang ẩn'}">JobFind Studio</dd>
                    </div>
                    <div>
                        <dt>Địa điểm</dt>
                        <dd th:text="${application.job?.location != null && application.job.location != '' ? application.job.location : 'Không công bố'}">Hà Nội</dd>
                    </div>
                    <div>
                        <dt>Mức lương</dt>
                        <dd th:text="${application.job?.salary != null && application.job.salary != '' ? application.job.salary : 'Thỏa thuận'}">Thỏa thuận</dd>
                    </div>
                </dl>
            </div>
        </div>
    </section>

    <section class="container detail-grid">
        <div class="detail-main">
            <article class="detail-card status-card">
                <div class="detail-card-head">
                    <div>
                        <p class="eyebrow">Tiến trình</p>
                        <h2>Trạng thái xử lý hồ sơ</h2>
                    </div>
                    <span class="status-chip" th:classappend="${' status-' + application.status}" th:text="${application.statusLabel}">Đã ứng tuyển</span>
                </div>
                <div class="detail-timeline" th:with="stages=${statusStages}">
                    <div class="detail-step" th:each="stage, iter : ${stages}" th:classappend="${application.statusIndex >= iter.index ? ' is-active' : ''}">
                        <span class="step-dot"></span>
                        <div>
                            <strong th:switch="${stage}">
                                <span th:case="'applied'">Ứng tuyển</span>
                                <span th:case="'viewed'">HR đã xem</span>
                                <span th:case="'shortlisted'">Shortlist</span>
                                <span th:case="'hired'">Offer</span>
                                <span th:case="*" th:text="${stage}"></span>
                            </strong>
                            <p class="step-text" th:switch="${stage}">
                                <span th:case="'applied'">Hồ sơ đã được gửi tới nhà tuyển dụng</span>
                                <span th:case="'viewed'">Hồ sơ của bạn đã được mở</span>
                                <span th:case="'shortlisted'">Bạn đang nằm trong danh sách phỏng vấn</span>
                                <span th:case="'hired'">Đang chờ kết quả cuối cùng / offer</span>
                                <span th:case="*">Đang xử lý</span>
                            </p>
                        </div>
                    </div>
                </div>
                <div th:if="${application.status == 'rejected'}" class="detail-note danger">
                    <i class="fa-solid fa-circle-exclamation me-2"></i>Nhà tuyển dụng đã từ chối hồ sơ này.
                </div>
                <div th:if="${application.status == 'hired'}" class="detail-note success">
                    <i class="fa-solid fa-circle-check me-2"></i>Chúc mừng! Bạn đã được nhận offer cho vị trí này.
                </div>
            </article>

            <article class="detail-card" th:if="${application.coverLetter}">
                <div class="detail-card-head">
                    <p class="eyebrow">Thư ứng tuyển</p>
                    <h2>Lời giới thiệu đã gửi</h2>
                </div>
                <div class="detail-body rich-text" th:text="${application.coverLetter}" style="white-space: pre-wrap;">
                    Nội dung thư ứng tuyển sẽ hiển thị tại đây.
                </div>
            </article>

            <article class="detail-card" th:if="${application.resumeSnapshot}">
                <div class="detail-card-head">
                    <p class="eyebrow">CV snapshot</p>
                    <h2>Thông tin CV tại thời điểm nộp</h2>
                </div>
                <div class="detail-note info">
                    <i class="fa-solid fa-circle-info me-2"></i>
                    Đây là nội dung CV/Resume được lưu cố định khi bạn ứng tuyển vị trí này.
                </div>
                <div class="detail-body rich-text" th:text="${application.resumeSnapshot}" style="white-space: pre-wrap;">
                    CV snapshot sẽ hiển thị tại đây.
                </div>
            </article>

            <article class="detail-card" th:if="${application.job?.description}">
                <div class="detail-card-head">
                    <p class="eyebrow">Mô tả tuyển dụng</p>
                    <h2>Những gì nhà tuyển dụng yêu cầu</h2>
                </div>
                <div class="detail-body rich-text" th:text="${application.job.description}">
                    Mô tả công việc...
                </div>
            </article>
        </div>

        <aside class="detail-aside">
            <div class="detail-card">
                <div class="detail-card-head">
                    <p class="eyebrow">Tóm tắt vị trí</p>
                    <h3>Thông tin chính</h3>
                </div>
                <ul class="detail-meta-list">
                    <li>
                        <span>Vị trí</span>
                        <strong th:text="${application.job?.title != null ? application.job.title : 'Chưa cập nhật'}">Product Designer</strong>
                    </li>
                    <li>
                        <span>Mức lương</span>
                        <strong th:text="${application.job?.salary != null && application.job.salary != '' ? application.job.salary : 'Thỏa thuận'}">Thỏa thuận</strong>
                    </li>
                    <li>
                        <span>Địa điểm</span>
                        <strong th:text="${application.job?.location != null && application.job.location != '' ? application.job.location : 'Linh hoạt'}">Hà Nội</strong>
                    </li>
                </ul>
            </div>

            <div class="detail-card action-card">
                <div class="detail-card-head">
                    <p class="eyebrow">Thao tác</p>
                    <h3>Quản lý đơn của bạn</h3>
                </div>
                <div class="detail-body">
                    <p class="text-muted mb-4">Bạn có thể xem lại tin tuyển dụng hoặc rút đơn nếu không còn theo đuổi vị trí này.</p>
                    <div class="d-grid gap-3">
                        <a th:href="@{/applications}" class="btn-ghost">
                            <i class="fa-solid fa-arrow-left me-2"></i>Về danh sách đơn
                        </a>
                        <a th:if="${application.job?.id != null}" th:href="@{/jobs/{id}(id=${application.job.id})}" class="btn-solid">
                            <i class="fa-solid fa-eye me-2"></i>Xem lại tin tuyển dụng
                        </a>
                        <form th:if="${application.status != 'hired' && application.status != 'rejected'}"
                              method="post"
                              th:action="@{/applications/{id}/withdraw(id=${application.id})}"
                              onsubmit="return confirm('Bạn có chắc muốn rút đơn ứng tuyển này?');">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button type="submit" class="btn-solid btn-danger w-100">
                                <i class="fa-solid fa-xmark me-2"></i>Rút đơn ứng tuyển
                            </button>
                        </form>
                        <div th:if="${application.status == 'hired' || application.status == 'rejected'}" class="detail-note neutral">
                            <i class="fa-solid fa-lock me-2"></i>Không thể rút đơn ở trạng thái hiện tại.
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </section>
</main>

<th:block th:replace="~{fragments/footer :: footer}" />
<th:block th:replace="~{fragments/footer :: backToTop}" />
<th:block th:replace="~{fragments/footer :: scripts}" />
</body>
</html>
