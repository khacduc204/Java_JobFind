<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{fragments/header :: head}" />
<body class="applications-page">
<th:block th:replace="~{fragments/header :: header}" />

<main class="applications-main">
    <section class="app-hero">
        <div class="container hero-grid">
            <div class="hero-copy">
                <p class="eyebrow">
                    <i class="fa-solid fa-bolt me-2"></i>
                    Hành trình ứng tuyển của bạn
                </p>
                <h1>Theo dõi mọi cơ hội đã gửi đi</h1>
                <p>Giữ nhịp với từng phản hồi từ nhà tuyển dụng, chủ động cập nhật CV và tiếp tục mở rộng hành trình sự nghiệp.</p>
                <div class="hero-actions">
                    <a th:href="@{/jobs}" class="btn-solid">
                        <i class="fa-solid fa-magnifying-glass me-2"></i>Tìm thêm việc phù hợp
                    </a>
                    <a th:href="@{/candidate/edit-profile}" class="btn-ghost">
                        <i class="fa-solid fa-pen-to-square me-2"></i>Cập nhật hồ sơ
                    </a>
                </div>
            </div>
            <div class="hero-panel">
                <div class="panel-title">Ảnh chụp nhanh</div>
                <div class="hero-metrics">
                    <div class="metric-card">
                        <span class="metric-label">Tổng đơn đã gửi</span>
                        <strong th:text="${total != null ? total : 0}">0</strong>
                        <small>bao gồm mọi vị trí đang theo dõi</small>
                    </div>
                    <div class="metric-card">
                        <span class="metric-label">Được shortlist</span>
                        <strong th:text="${statusCounts['shortlisted'] ?: 0}">0</strong>
                        <small>đơn đã qua vòng sàng lọc</small>
                    </div>
                    <div class="metric-card">
                        <span class="metric-label">Offer thành công</span>
                        <strong th:text="${statusCounts['hired'] ?: 0}">0</strong>
                        <small>cơ hội đã chốt nhận việc</small>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="app-panel container">
        <div th:if="${flashMessage}" th:class="${'alert alert-' + flashType + ' shadow-sm applications-alert'}" role="alert">
            <i class="fa-solid" th:classappend="${flashType == 'success' ? ' fa-circle-check' : ' fa-triangle-exclamation'}"></i>
            <span th:text="${flashMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div class="filters-card">
            <form method="get" th:action="@{/applications}" class="search-form">
                <div class="form-field">
                    <label for="keyword">Từ khóa</label>
                    <div class="input-icon">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" id="keyword" name="keyword" th:value="${filterKeyword}" placeholder="Tên công việc, công ty hoặc kỹ năng">
                    </div>
                </div>
                <input type="hidden" name="status" th:value="${filterStatus != null ? filterStatus : ''}">
                <button type="submit" class="btn-solid">
                    <i class="fa-solid fa-search me-2"></i>Lọc kết quả
                </button>
                <a th:if="${(filterStatus != null and filterStatus != '') or (filterKeyword != null and filterKeyword != '')}" th:href="@{/applications}" class="btn-link-reset">Xóa bộ lọc</a>
            </form>

            <div class="status-filter" th:if="${statusFilters != null}">
                <a th:each="status : ${statusFilters}"
                   th:href="@{/applications(status=${status.value}, keyword=${filterKeyword})}"
                   th:class="${'filter-chip' + (filterStatus == status.value ? ' is-active' : '')}">
                    <span class="chip-label" th:text="${status.label}">Tất cả</span>
                    <span class="chip-count" th:text="${status.count}">0</span>
                </a>
            </div>
        </div>

        <div th:if="${#lists.isEmpty(applications)}" class="app-empty">
            <div class="empty-icon">
                <i class="fa-regular fa-inbox"></i>
            </div>
            <h3>Chưa có đơn ứng tuyển nào</h3>
            <p>Tạo dấu ấn đầu tiên bằng việc ứng tuyển một vị trí phù hợp ngay hôm nay.</p>
            <div class="empty-actions">
                <a th:href="@{/jobs}" class="btn-solid">
                    <i class="fa-solid fa-magnifying-glass me-2"></i>Khám phá việc làm mới
                </a>
                <a th:href="@{/candidate/profile}" class="btn-ghost">
                    <i class="fa-solid fa-user me-2"></i>Hoàn thiện hồ sơ
                </a>
            </div>
        </div>

        <div th:unless="${#lists.isEmpty(applications)}" class="applications-wrapper">
            <article th:each="app : ${applications}" class="application-card">
                <div class="card-header">
                    <div class="employer-mark"
                         th:text="${app.employerName != null and !#strings.isEmpty(app.employerName) ? #strings.substring(app.employerName,0,1) : 'J'}">
                        J
                    </div>
                    <div class="job-info">
                        <a th:if="${app.jobId != null}" th:href="@{/jobs/{id}(id=${app.jobId})}" class="job-title" th:text="${app.jobTitle}">Vị trí đang tuyển</a>
                        <span th:unless="${app.jobId != null}" class="job-title" th:text="${app.jobTitle}">Vị trí đang tuyển</span>
                        <p class="company-line">
                            <span th:text="${app.employerName != null && app.employerName != '' ? app.employerName : 'Nhà tuyển dụng ẩn'}">Công ty A</span>
                            <span th:if="${app.jobLocation != null && app.jobLocation != ''}">
                                <i class="fa-solid fa-circle fa-2xs mx-2"></i>
                                <span th:text="${app.jobLocation}">Hà Nội</span>
                            </span>
                        </p>
                        <div class="job-meta">
                            <span>
                                <i class="fa-regular fa-money-bill-1 me-2"></i>
                                <span th:text="${app.jobSalary != null && app.jobSalary != '' ? app.jobSalary : 'Thỏa thuận'}">Thỏa thuận</span>
                            </span>
                            <span th:if="${app.coverLetter != null && app.coverLetter != ''}">
                                <i class="fa-regular fa-message me-2"></i>
                                <span th:text="${#strings.abbreviate(app.coverLetter, 80)}">Cover letter</span>
                            </span>
                        </div>
                    </div>
                    <div class="status-stack">
                        <span class="status-chip" th:classappend="${' status-' + app.status}" th:text="${app.statusLabel}">Đã ứng tuyển</span>
                        <small class="status-time">
                            <i class="fa-regular fa-clock me-1"></i>
                            <span th:if="${app.appliedAt}" th:text="${#temporals.format(app.appliedAt, 'dd/MM/yyyy')}">01/01/2024</span>
                            <span th:unless="${app.appliedAt}">Chưa xác định</span>
                        </small>
                    </div>
                </div>
                <div class="card-progress" th:with="stages=${statusStages}">
                    <div class="progress-track">
                        <div class="progress-step" th:each="stage, iter : ${stages}" th:classappend="${app.statusIndex >= iter.index ? ' is-active' : ''}">
                            <span class="step-dot"></span>
                            <span class="step-label" th:switch="${stage}">
                                <span th:case="'applied'">Ứng tuyển</span>
                                <span th:case="'viewed'">HR đã xem</span>
                                <span th:case="'shortlisted'">Shortlist</span>
                                <span th:case="'hired'">Offer</span>
                                <span th:case="*" th:text="${stage}"></span>
                            </span>
                        </div>
                    </div>
                    <div th:if="${app.status == 'rejected'}" class="progress-note is-danger">
                        <i class="fa-solid fa-circle-exclamation me-2"></i>Hồ sơ đã bị từ chối
                    </div>
                </div>
                <div class="card-footer">
                    <div class="footer-actions">
                        <a th:href="@{/applications/{id}(id=${app.id})}" class="btn-ghost">
                            <i class="fa-solid fa-eye me-2"></i>Xem chi tiết
                        </a>
                        <form th:if="${app.status != 'hired' && app.status != 'rejected'}"
                              method="post"
                              th:action="@{/applications/{id}/withdraw(id=${app.id})}"
                              onsubmit="return confirm('Bạn có chắc muốn rút đơn?');">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                            <button type="submit" class="btn-solid btn-danger">
                                <i class="fa-solid fa-xmark me-2"></i>Rút đơn
                            </button>
                        </form>
                    </div>
                </div>
            </article>

            <nav th:if="${totalPages > 1}" class="app-pagination">
                <ul class="pagination justify-content-center">
                    <li class="page-item" th:classappend="${currentPage == 1 ? 'disabled' : ''}">
                        <a class="page-link" th:href="@{/applications(page=${currentPage - 1}, status=${filterStatus}, keyword=${filterKeyword})}">Trước</a>
                    </li>
                    <li th:each="i : ${#numbers.sequence(1, totalPages)}" class="page-item" th:classappend="${i == currentPage ? 'active' : ''}">
                        <a class="page-link" th:href="@{/applications(page=${i}, status=${filterStatus}, keyword=${filterKeyword})}" th:text="${i}">1</a>
                    </li>
                    <li class="page-item" th:classappend="${currentPage == totalPages ? 'disabled' : ''}">
                        <a class="page-link" th:href="@{/applications(page=${currentPage + 1}, status=${filterStatus}, keyword=${filterKeyword})}">Sau</a>
                    </li>
                </ul>
            </nav>
        </div>
    </section>
</main>

<th:block th:replace="~{fragments/footer :: footer}" />
<th:block th:replace="~{fragments/footer :: backToTop}" />
<th:block th:replace="~{fragments/footer :: scripts}" />
</body>
</html>
